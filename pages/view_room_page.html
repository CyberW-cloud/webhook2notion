<!DOCTYPE html>
<html>
<head>
  <style type="text/css" media="screen">
    body { background-color: #333333}
    
    .main-container {width:90%;background-color: #505050; margin-left: 1%;}
    .message {padding: 3px;text-align: left; color: #F0F0F0;
        border-radius: 25px;background-color: #444444; margin-left: 5%;}
    .message .msg {margin-left: 1%}
    .message:hover {background-color: #808080; color: black;}
    .message-name {color: #F0F0F0;}
  </style>
</head>

<body onload="main()">

  <h1 style="color:white;text-align: center;">Message history</h1>

  <div class="main-container">
    <!-- JS will fill this container later -->
  </div>

<script type="text/javascript">
  function strip(text)
  {
    // Remove style tags and content
    text.replace(/<style[^>]*>.*<\/style>/gm, '')
        // Remove script tags and content
        .replace(/<script[^>]*>.*<\/script>/gm, '')
        // Remove all opening, closing and orphan HTML tags
        .replace(/<[^>]+>/gm, '')
        // Remove leading spaces and repeated CR/LF
        .replace(/([\r\n]+ +)+/gm, '');
     return text;
  }

  function httpGet(theUrl)
  {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    return xmlHttp.responseText;
  }

  function main() {  
    var urlParams = new URLSearchParams(window.location.search);
  
    if (!urlParams.has("ac_user")){
      alert("ERROR: no user!")
      return
    }
    if (!urlParams.has("room_id"))
    {
      alert("ERROR: no room id!")
      return      
    }
    
    messages = httpGet("https://dev-etc-to-notion.herokuapp.com/get_room_messages?ac_user="+urlParams.get("ac_user")+"&room_id="+urlParams.get("room_id"))
    
    update_table(JSON.parse(messages))
  }


  function update_table(messages){

    var container = document.getElementsByClassName('main-container')[0]  
    //autofilled by python on creation

    let prev_username = ""
    for (var i = messages.length - 1; i >= 0; i--) {
      container.innerHTML += "<div class=\"message-container\">"

      if (prev_username !== messages[i]["name"]){
        name = strip(messages[i]["name"]).replace("\n", "<br>")
        container.innerHTML += "<br><div class=\"message-name\">" + name + ":<div/>"
      }


      time = strip(messages[i]["date"]).replace("\n", "<br>")

      message = strip(messages[i]["message"]).replace("\n", "<br>")

      container.innerHTML += "<div class=\"message\"><b>" + time + "<b/><br>" +  message + "<div/>"
      container.innerHTML += "<div/>"
      
    }  
  }
</script>
</body>

</html>
